from typing import Any, Dict, List

from pymongo import MongoClient

from config.logger import logger
from src.model.cve_repository import CVERepository


class MongoDBCVERepository(CVERepository):
    def __init__(self, collection_name: str):
        self._client = MongoClient("mongodb://admin:password@localhost:27017/")
        self._db = self._client["admin"]
        self._collection_name = collection_name
        self._collection = self._db[self._collection_name]

        if self._collection_name not in self._db.list_collection_names():
            # Create collection if it doesn't exist
            self._db.create_collection(self._collection_name)
            self._collection.create_index([("cve_id", 1)])
            logger.info(f"Collection '{self._collection_name}' created.")
        else:
            logger.info(f"Collection '{self._collection_name}' already exists.")

    def update(self, cve: Dict[str, Any]) -> None:
        self._collection.update_one({"cve_id": cve["cve_id"]}, {"$setOnInsert": cve}, upsert=True)
        logger.info(f"Inserted {cve['cve_id']} in {self._collection_name}")

    def find_all(self) -> List[Dict[str, Any]]:
        cursor = self._collection.find()
        return list(cursor)
