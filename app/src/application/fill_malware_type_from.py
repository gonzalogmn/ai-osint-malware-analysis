import pandas as pd

from config.logger import logger
from src.model.cve_repository import CVERepository

MALWARE_TYPES = {
    "virus": [
        "virus",
        "infection",
        "infect",
        "infects",
        "infected",
        "replication",
        "replicate",
        "replicates",
    ],
    "worm": ["worm"],
    "trojan": ["trojan"],
    "adware": ["adware"],
    "rootkit": ["rootkit"],
    "ransomware": ["ransomware"],
    "keylogger": ["keylogger"],
    "bot": ["bot"],
    "spyware": ["spyware"],
    "phishing": ["phishing"],
    "fileless_malware": ["fileless"],
    "mobile_malware": ["mobile"],
    "wiper_malware": ["wiper"],
}

NO_MALWARE_TYPES = {
    "Buffer Overflow": [
        "buffer overflow",
        "stack overflow",
        "heap overflow",
        "buffer overrun",
        "stack corruption",
    ],
    "SQL Injection": ["sql injection", "injection", "sql vulnerability", "injection flaw"],
    "Remote Code Execution": [
        "remote code execution",
        "arbitrary code execution",
        "rce",
        "code injection",
    ],
    "Privilege Escalation": [
        "privilege escalation",
        "gain privileges",
        "escalate privileges",
        "elevation of privilege",
    ],
    "Denial of Service": [
        "denial of service",
        "dos",
        "ddos",
        "service disruption",
        "service degradation",
    ],
    "Cross-Site Scripting": [
        "cross-site scripting",
        "xss",
        "xss vulnerability",
        "cross site scripting",
    ],
    "File Upload Vulnerability": [
        "file upload vulnerability",
        "malicious file upload",
        "upload exploit",
        "unrestricted file upload",
    ],
    "Unauthorized Access": [
        "unauthorized access",
        "bypass authentication",
        "unauthorized login",
        "security bypass",
    ],
    "Backdoor": ["backdoor", "unauthorized access", "remote access", "backdoor entry"],
}


class FillMalwareTypeFrom:
    def __init__(
        self, input_repository: CVERepository, output_repository: CVERepository, from_column: str
    ):
        self._input_repository = input_repository
        self._output_repository = output_repository
        self._from_column = from_column

    def _determine_malware_type(self, row, column):
        if pd.isna(row[column]):
            return "unknown"

        description = row[column].lower()
        logger.info(description)
        for malware_type, keywords in MALWARE_TYPES.items():
            for keyword in keywords:
                if keyword in description:
                    return malware_type
        return "unknown"

    def __call__(self):
        cves = self._input_repository.find_all()

        df = pd.DataFrame(cves)

        df["malware_type"] = df.apply(
            lambda row: (
                self._determine_malware_type(row, self._from_column)
                if "malware_type" not in row
                or pd.isnull(row["malware_type"])
                or row["malware_type"] == "unknown"
                else row["malware_type"]
            ),
            axis=1,
        )

        data_dict = df.to_dict("records")
        for cve in data_dict:
            self._output_repository.update_malware_type(cve)
