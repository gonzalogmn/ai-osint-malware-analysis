import pandas as pd

from config.logger import logger
from src.model.cve_repository import CVERepository
from src.model.malware_types import MalwareType

MALWARE_TYPES = {
    MalwareType.VIRUS.value: [
        "virus",
        "infection",
        "infect",
        "infects",
        "infected",
        "replication",
        "replicate",
        "replicates",
    ],
    MalwareType.WORM.value: ["worm"],
    MalwareType.TROJAN.value: ["trojan"],
    MalwareType.ADWARE.value: ["adware"],
    MalwareType.ROOTKIT.value: ["rootkit"],
    MalwareType.RANSOMWARE.value: ["ransomware"],
    MalwareType.KEYLOGGER.value: ["keylogger"],
    MalwareType.BOT.value: ["bot"],
    MalwareType.SPYWARE.value: ["spyware"],
    MalwareType.PHISHING.value: ["phishing"],
    MalwareType.FILELESS_MALWARE.value: ["fileless"],
    MalwareType.MOBILE_MALWARE.value: ["mobile"],
    MalwareType.WIPER_MALWARE.value: ["wiper"],
}


class FillMalwareTypeFrom:
    def __init__(
        self, input_repository: CVERepository, output_repository: CVERepository, from_column: str
    ):
        self._input_repository = input_repository
        self._output_repository = output_repository
        self._from_column = from_column

    def _determine_malware_type(self, row, column):
        if pd.isna(row[column]):
            return "unknown"

        description = row[column].lower()
        for malware_type, keywords in MALWARE_TYPES.items():
            for keyword in keywords:
                if keyword in description:
                    return malware_type
        return "unknown"

    def __call__(self):
        logger.info("Starting FillMalwareTypeFrom use case...")
        cves = self._input_repository.find_all()

        df = pd.DataFrame(cves)

        df["malware_type"] = df.apply(
            lambda row: (
                self._determine_malware_type(row, self._from_column)
                if "malware_type" not in row
                or pd.isnull(row["malware_type"])
                or row["malware_type"] == "unknown"
                else row["malware_type"]
            ),
            axis=1,
        )

        data_dict = df.to_dict("records")
        for cve in data_dict:
            self._output_repository.update_malware_type(cve)
