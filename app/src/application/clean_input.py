import pandas as pd

from src.model.cve_repository import CVERepository


class CleanInput:
    def __init__(self, input_repository: CVERepository, output_repository: CVERepository):
        self._input_repository = input_repository
        self._output_repository = output_repository

    def __call__(self):
        documents = self._input_repository.find_all()
        df = pd.DataFrame(documents)

        df.dropna(subset=["cve_id"], inplace=True)
        df.dropna(subset=["date_published"], inplace=True)
        df["affected_product"] = df["affected_product"].replace("n/a", None)
        df["affected_vendor"] = df["affected_vendor"].replace("n/a", None)
        df.drop_duplicates(subset=["cve_id", "date_published"], inplace=True)

        data_dict = df.to_dict("records")
        for cve in data_dict:
            self._output_repository.update(cve)
